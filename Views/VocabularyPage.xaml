<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="QQLyric2Roma.Views.VocabularyPage"
             Title="记忆">

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        
        <!-- 顶部：Tab按钮 + 编辑按钮 -->
        <Grid Grid.Row="0" Padding="10" ColumnDefinitions="*,Auto">
            <HorizontalStackLayout Grid.Column="0"
                                   HorizontalOptions="Center" 
                                   Spacing="10">
                <Button x:Name="BtnLyrics" 
                        Text="歌词" 
                        Clicked="OnTabClicked"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        WidthRequest="100"/>
                <Button x:Name="BtnJapanese" 
                        Text="日语词汇" 
                        Clicked="OnTabClicked"
                        BackgroundColor="LightGray"
                        TextColor="Black"
                        WidthRequest="100"/>
                <Button x:Name="BtnEnglish" 
                        Text="英语词汇" 
                        Clicked="OnTabClicked"
                        BackgroundColor="LightGray"
                        TextColor="Black"
                        WidthRequest="100"/>
            </HorizontalStackLayout>

            <Button x:Name="BtnEdit"
                    Grid.Column="1"
                    Text="编辑"
                    FontSize="16"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="8"
                    Padding="20,8"
                    VerticalOptions="Center"
                    Clicked="OnEditModeClicked"/>
        </Grid>

        <!-- 搜索框（仅在词汇 Tab 显示） -->
        <SearchBar x:Name="VocabSearchBar"
                   Grid.Row="1"
                   Placeholder="搜索词汇（词语、读音、释义）..."
                   IsVisible="False"
                   TextChanged="OnVocabSearchTextChanged"
                   SearchButtonPressed="OnVocabSearchButtonPressed"
                   Margin="10,0"/>

        <Grid Grid.Row="2">
            <CollectionView x:Name="LyricsList" 
                            IsVisible="True"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Label Text="暂无保存的歌词" 
                               FontSize="16" 
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                        <Label Text="在歌词页面点击保存按钮添加" 
                               FontSize="14" 
                               TextColor="LightGray"
                               HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="删除" 
                                               BackgroundColor="Red" 
                                               Invoked="OnDeleteLyricSwiped"/>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Margin="10,5" 
                                    Padding="15" 
                                    StrokeShape="RoundRectangle 8"
                                    Stroke="Transparent">
                                <Grid ColumnDefinitions="Auto,*">
                                    <CheckBox x:Name="LyricCheckBox"
                                              Grid.Column="0"
                                              IsChecked="{Binding IsSelected}"
                                              IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsEditMode}"
                                              VerticalOptions="Center"/>
                                    <StackLayout Grid.Column="1">
                                        <StackLayout.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnLyricTapped" CommandParameter="{Binding .}"/>
                                        </StackLayout.GestureRecognizers>
                                        <Label Text="{Binding DisplayText}" 
                                               FontSize="16" 
                                               FontAttributes="Bold"/>
                                        <Label Text="{Binding CreatedAtText}" 
                                               FontSize="12" 
                                               TextColor="Gray"/>
                                    </StackLayout>
                                </Grid>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <CollectionView x:Name="JapaneseList" 
                            IsVisible="False"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Label Text="暂无日语词汇" 
                               FontSize="16" 
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="删除" 
                                               BackgroundColor="Red" 
                                               Invoked="OnDeleteVocabSwiped"/>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Margin="10,5" 
                                    Padding="15" 
                                    StrokeShape="RoundRectangle 8"
                                    Stroke="Transparent">
                                <VerticalStackLayout>
                                    <!-- 简略信息（始终显示） -->
                                    <Grid ColumnDefinitions="Auto,*">
                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsSelected}"
                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsEditMode}"
                                                  VerticalOptions="Center"/>
                                        <StackLayout Grid.Column="1">
                                            <StackLayout.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnVocabTapped" CommandParameter="{Binding .}"/>
                                            </StackLayout.GestureRecognizers>
                                            <Label Text="{Binding Word}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold"/>
                                            <Label Text="{Binding Reading}" 
                                                   FontSize="14" 
                                                   TextColor="Gray"/>
                                            <Label Text="{Binding Meaning}" 
                                                   FontSize="14"/>
                                            <Label Text="{Binding CreatedAtText}" 
                                                   FontSize="12" 
                                                   TextColor="LightGray"/>
                                        </StackLayout>
                                    </Grid>

                                    <!-- 详细信息（展开时显示） -->
                                    <VerticalStackLayout IsVisible="{Binding IsExpanded}" 
                                                         Margin="0,10,0,0"
                                                         Padding="10"
                                                         BackgroundColor="#F0F0F0">
                                        <!-- 上下文 -->
                                        <StackLayout IsVisible="{Binding HasContext}" Margin="0,0,0,8">
                                            <Label Text="上下文" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding Context}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 用法 -->
                                        <StackLayout IsVisible="{Binding HasUsage}" Margin="0,0,0,8">
                                            <Label Text="用法" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding Usage}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 例句 -->
                                        <StackLayout IsVisible="{Binding HasExamples}" Margin="0,0,0,8">
                                            <Label Text="例句" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding ExamplesDisplay}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 编辑按钮 -->
                                        <Button Text="编辑此词汇"
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White"
                                                FontSize="14"
                                                Margin="0,5,0,0"
                                                Clicked="OnEditVocabClicked"
                                                CommandParameter="{Binding .}"/>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <CollectionView x:Name="EnglishList" 
                            IsVisible="False"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Label Text="暂无英语词汇" 
                               FontSize="16" 
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItems>
                                    <SwipeItem Text="删除" 
                                               BackgroundColor="Red" 
                                               Invoked="OnDeleteVocabSwiped"/>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Border Margin="10,5" 
                                    Padding="15" 
                                    StrokeShape="RoundRectangle 8"
                                    Stroke="Transparent">
                                <VerticalStackLayout>
                                    <!-- 简略信息（始终显示） -->
                                    <Grid ColumnDefinitions="Auto,*">
                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsSelected}"
                                                  IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.IsEditMode}"
                                                  VerticalOptions="Center"/>
                                        <StackLayout Grid.Column="1">
                                            <StackLayout.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnVocabTapped" CommandParameter="{Binding .}"/>
                                            </StackLayout.GestureRecognizers>
                                            <Label Text="{Binding Word}" 
                                                   FontSize="18" 
                                                   FontAttributes="Bold"/>
                                            <Label Text="{Binding Reading}" 
                                                   FontSize="14" 
                                                   TextColor="Gray"/>
                                            <Label Text="{Binding Meaning}" 
                                                   FontSize="14"/>
                                            <Label Text="{Binding CreatedAtText}" 
                                                   FontSize="12" 
                                                   TextColor="LightGray"/>
                                        </StackLayout>
                                    </Grid>

                                    <!-- 详细信息（展开时显示） -->
                                    <VerticalStackLayout IsVisible="{Binding IsExpanded}" 
                                                         Margin="0,10,0,0"
                                                         Padding="10"
                                                         BackgroundColor="#F0F0F0">
                                        <!-- 上下文 -->
                                        <StackLayout IsVisible="{Binding HasContext}" Margin="0,0,0,8">
                                            <Label Text="上下文" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding Context}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 用法 -->
                                        <StackLayout IsVisible="{Binding HasUsage}" Margin="0,0,0,8">
                                            <Label Text="用法" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding Usage}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 例句 -->
                                        <StackLayout IsVisible="{Binding HasExamples}" Margin="0,0,0,8">
                                            <Label Text="例句" FontAttributes="Bold" FontSize="13" TextColor="#666"/>
                                            <Label Text="{Binding ExamplesDisplay}" FontSize="14"/>
                                        </StackLayout>

                                        <!-- 编辑按钮 -->
                                        <Button Text="编辑此词汇"
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White"
                                                FontSize="14"
                                                Margin="0,5,0,0"
                                                Clicked="OnEditVocabClicked"
                                                CommandParameter="{Binding .}"/>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Border>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- 底部删除按钮（编辑模式时显示） -->
        <Button x:Name="BtnDeleteSelected"
                Grid.Row="3"
                Text="删除选中"
                BackgroundColor="Red"
                TextColor="White"
                Margin="10"
                IsVisible="False"
                Clicked="OnDeleteSelectedClicked"/>
    </Grid>
</ContentPage>
